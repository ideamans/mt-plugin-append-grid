<mt:if name="id">
    <mt:setvar name="page_title" value="<__trans phrase="Edit AppendGrid Schema">">
<mt:else>
    <mt:setvar name="page_title" value="<__trans phrase="Create AppendGrid Schema">">
</mt:if>

<$mt:setvar name="position_actions_bottom" value="1"$>

<mt:SetVarBlock name="system_msg">
<mt:if name="error">
  <mtapp:statusmsg
     id="generic-error"
     class="error"
     can_close="0">
    <mt:var name="error">
  </mtapp:statusmsg>
</mt:if>
<mt:if name="saved">
  <mtapp:statusmsg
     id="saved"
     class="success">
    <__trans phrase="Your changes have been saved.">
  </mtapp:statusmsg>
</mt:if>
</mt:SetVarBlock>

<mt:setvarblock name="jq_js_include" append="1">
(function($) {
    var updateSchemaFormatState = function() {
        var format = $('#schema_format_yaml').attr('checked') ? 'yaml' : 'json';
        console.log(format);
        if ( format == 'yaml' ) {
            $('#schema_json-field').hide();
            $('#schema_yaml-field').fadeIn('fast');
        } else {
            $('#schema_yaml-field').hide();
            $('#schema_json-field').fadeIn('fast');
        }
    };

    updateSchemaFormatState();
    $('.schema_selector').click(updateSchemaFormatState);
})(jQuery);
</mt:setvarblock>

<mt:setvarblock name="html_head" append="1">
<link rel="stylesheet" href="<$mt:var name="static_uri"$>plugins/AppendGrid/jquery-ui/jquery-ui.min.css?v=<mt:var name='plugin_version'>" type="text/css" />
<link rel="stylesheet" href="<$mt:var name="static_uri"$>plugins/AppendGrid/jquery.appendGrid/jquery.appendGrid-1.5.0.min.css?v=<mt:var name='plugin_version'>" type="text/css" />
<link rel="stylesheet" href="<$mt:var name="static_uri"$>plugins/AppendGrid/mt-append-grid.css?v=<mt:var name='plugin_version'>" type="text/css" />
<style type="text/css">
  #schema_yaml-field, #schema_json-field { display: none; }
</style>
<script type="text/javascript" src="<mt:var name='static_uri'>plugins/AppendGrid/jquery.appendGrid/jquery.appendGrid-1.5.0.min.js?v=<mt:var name='plugin_version'>"></script>
<script type="text/javascript" src="<mt:var name='static_uri'>plugins/AppendGrid/mt-append-grid.js?v=<mt:var name='plugin_version'>"></script>
</mt:setvarblock>

<mt:setvar name="screen_group" value="custom_fields" />
<mt:include name="include/header.tmpl" id="header_include">

<form method="post" action="<mt:var name="script_url">" id="edit_append_grid_schema">
  <input type="hidden" id="blog-id" name="blog_id" value="<mt:var name="blog_id" escape="html">" />
  <input type="hidden" name="__mode" value="save" />
  <input type="hidden" name="_type" value="<mt:var name="object_type">" />
  <input type="hidden" name="id" value="<mt:var name="id" escape="html">" id="id" />
  <input type="hidden" name="return_args" value="<mt:var name="return_args" escape="html">" />
  <input type="hidden" name="magic_token" value="<mt:var name="magic_token">" />

  <mtapp:settinggroup id="appned_grid_schema">

    <mtapp:setting
       id="label"
       label_class="top-label"
       label="<__trans phrase="Label">"
       required="1">
      <input type="text" name="name" id="name" class="text full required" maxlength="100" value="<mt:var name="name" escape="html">" />
    </mtapp:setting>

    <mtapp:setting
       id="description"
       label_class="top-label"
       label="<__trans phrase="Description">">
       <textarea name="description" id="description" class="text low full" rows="5"><mt:var name="description" escape="html"></textarea>
    </mtapp:setting>

    <mtapp:setting
       id="schema_format"
       label_class="top-label"
       label="<__trans phrase="Schema Format">">
        <ul>
            <li>
                <label>
                    <input type="radio" id="schema_format_yaml" name="schema_format" class="rb schema_selector" value="yaml"<mt:if name='schema_format' eq='yaml'> checked="checked"</mt:if>>
                    <__trans phrase="YAML">
                </label>
                <label>
                    <input type="radio" id="schema_format_json" name="schema_format" class="rb schema_selector" value="json"<mt:if name='schema_format' ne='yaml'> checked="checked"</mt:if>>
                    <__trans phrase="JSON">
                </label>
            </li>
        </ul>
    </mtapp:setting>

    <mtapp:setting
       id="schema_json"
       label_class="top-label"
       label="<__trans phrase="Schema JSON">">
       <textarea name="schema_json" id="schema_json" class="text high full" rows="5"><mt:var name="schema_json" escape="html"></textarea>
    </mtapp:setting>

    <mtapp:setting
       id="schema_yaml"
       label_class="top-label"
       label="<__trans phrase="Schema YAML">">
       <textarea name="schema_yaml" id="schema_yaml" class="text high full" rows="5"><mt:var name="schema_yaml" escape="html"></textarea>
    </mtapp:setting>

    <mtapp:setting
      id="schema_preview"
      label_class="top-label"
      label="<__trans phrase='Preview'>">
    <img src="<mt:var name='static_uri'>images/indicator.gif" id="preview_indicator" style="display: none" />
    <div id="preview_error" style="display: none">
      <mtapp:statusmsg
         id="preview_error_msg"
         class="error"
         can_close="0">
         <span></span>
      </mtapp:statusmsg>
    </div>
    <div class="append-grid-wrapper">
      <table id="schema_preview" style="display: none"></table>
    </div>
    <div class="actions-bar actions-bar-bottom">
      <button
        id="update_preview"
        type="button"
        accesskey="p"
        title="<__trans phrase="Preview this scheama (p)">"
        class="action button preview"
        ><__trans phrase="Preview"></button>
    </div>
    </mtapp:setting>

  </mtapp:settinggroup>

  <script>
  (function($) {
    var $table = $('#schema_preview'),
        $indicator = $('#preview_indicator'),
        $error = $('#preview_error');

    var updatePreview = function() {
      $table.children().remove();
      $table.hide();
      $error.hide();
      $indicator.fadeIn('fast');

      var data = {
        schema_format: $('#schema_format_yaml').attr('checked') ? 'yaml' : 'json',
        schema_yaml: $('#schema_yaml').val(),
        schema_json: $('#schema_json').val(),
      };

      $.post("<mt:var name='preview_url' escape='js'>", data)
        .done(function(data) {
          if ( data.error ) {
            $error.show().find('p.msg-text').text(data.error);
          } else if ( data.result && data.result.schema ) {
            console.log(data.result.schema);
            try {
              $.mtAppendGrid.setupGrid({
                  options: data.result.schema,
                  forces: {},
                  grid: $table,
              });
              $table.fadeIn('fast');
            } catch (ex) {
              if ( console ) console.log(ex);
              $error.show().find('p.msg-text').text(ex.message);
            }
          }
        })
        .fail(function(status, line, jqXHR) {
          $error.show().find('p.msg-text').text(status + " " + line);
        })
        .always(function() {
          $indicator.hide();
        });
    };
    $('#update_preview').click(updatePreview);
    updatePreview();
  })(jQuery);
  </script>

  <mt:setvarblock name="action_buttons">
    <button
       type="submit"
       accesskey="s"
       title="<__trans phrase="Save changes to this schema (s)">"
       class="save action button primary"
       ><__trans phrase="Save Changes"></button>
  </mt:setvarblock>

  <mt:include name="include/actions_bar.tmpl" bar_position="bottom" hide_pager="1" settings_bar="1">

</form>

<mt:include name="include/footer.tmpl">
